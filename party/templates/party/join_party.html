<!DOCTYPE html>

{% extends "base.html" %}

{% block page_content %}

<script>
	var invalid = "{{invalid}}";
	$(document).ready(function () {
		var button = document.getElementById('button');
		var carousel = document.getElementById('swipe');
		if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
			button.style.display = 'none';
			carousel.style.display = 'block';
		}
		else{
			button.style.display = 'block';
			carousel.style.display = 'none';
		}
		if(invalid == 'True'){
			document.getElementById('code_validator').style.display = 'block';
		}
		var main = document.getElementById('main');
		initPos(main);
		main.addEventListener('scroll', scrollVisible);
	});

	async function scrollSubmit(){
		var slide = document.getElementById('carousel__slide1');
		var width = getWidth(slide);
		var swipe = document.getElementById('swipe');
		var main = document.getElementById('main');
		var swipe_icon = document.getElementById('swipe_icon');
		var swipe_content = document.getElementById('swipe_content');
		var iWidth = getWidth(swipe_icon);
		var sWidth = getWidth(swipe);
		iWidth += getMarginLeft(swipe_icon);
		if(main.scrollLeft < iWidth){
			main.classList.remove('scroll-snap-man');
			main.style.overflow = "hidden";
			swipe.style.width = iWidth + 'px';
			swipe_content.style.display = 'none';
			main.scrollLeft = iWidth;
			main.removeEventListener('scroll', scrollSubmit);
			await delay(setSwipeIconMargin, 'auto', 1000);
			//console.log('here1');
			//var loader = document.getElementById('loader');
			//loader.style.display = 'block';
			//await delay(setSwipeIconMargin, 'auto', 3000);
			if (validateInput()) {
				document.joinParty.submit();
			}
			else {
				setTimeout(function(){
					swipe.style.width = sWidth + 'px';
					main.classList.add('scroll-snap-man');
					main.style.overflow = "";
					initPos(main);
					setSwipeIconMargin('auto 0 auto .25em');
					swipe_content.style.display = 'block';
					main.addEventListener('scroll', scrollSubmit);
				}, 1500);
			}
		}
	}

	function scrollAnimate(){
		var slide = document.getElementById('carousel__slide1');
		var width = getWidth(slide);
		var main = document.getElementById('main');
		var text = document.getElementById('swipe_content');
		text.style.opacity = (((main.scrollLeft / width) * 100) / 2) + '%';
	}

	function scrollVisible(){
		var slide = document.getElementById('carousel__slide1');
		var width = getWidth(slide);
		var main = document.getElementById('main');
		var swipe_icon = document.getElementById('swipe_icon');
		if(width == main.scrollLeft){
			swipe_icon.style.visibility = 'visible';
			main.removeEventListener('scroll', scrollVisible);
			main.addEventListener('scroll', scrollSubmit);
			main.addEventListener('scroll', scrollAnimate);
		}
	}

	function initPos(viewport){
		var slide = document.getElementById('carousel__slide1');
		var width = getWidth(slide);
		viewport.scroll(width, 0);
	}

	function getWidth(element){
        var style = getComputedStyle(element);
        var width = style.getPropertyValue("width");
        width = parseInt(width.split("px")[0]);
        return width;
	}

	function getMarginLeft(element){
		var style = getComputedStyle(element);
		var marginLeft = style.marginLeft;
		return parseInt(marginLeft)
	}

	function setSwipeIconMargin(margin){
		console.log('here2');
		icon = document.getElementById('swipe_icon').style.margin = margin;
	}


	function delay(funct, param, ms){
  		setTimeout(function(){funct(param)}, ms);
	}

	function validateInput(){
		var main = document.getElementById('main');
		var valid = true;
		var code = document.getElementById('id_party_code');
		var codeInfo = document.getElementById('code_validator');
		var codeText = document.getElementById('code_text');
		if(code.value == ""){
			codeText.style.display = 'block';
			codeInfo.style.display = 'none';
			valid = false;
		}
		else if (validateCode(code.value) == 'False'){
			codeInfo.style.display = 'block';
			codeText.style.display = 'none';
			valid = false;
		}
		else{
			codeInfo.style.display = 'none';
			codeText.style.display = 'none';
		}
		var name = document.getElementById('id_user_name');
		var nameInfo = document.getElementById('name_validator');
		if (name.value == ""){
			nameInfo.style.display = 'block';
			valid = false;
		}
		else{
			nameInfo.style.display = 'none';
		}
	}

	function validateCode(code){
		$.ajax({
			url: '/party/validate_code',
			data: {
				'code': code,
			},
			dataType: 'json',
			success: function (data) {
				return data.valid
			},
			error: function(data){
				return false;
			}
		});
	}
</script>


<style>
	@keyframes tonext {
	  75% {
		left: 0;
	  }
	  95% {
		left: 100%;
	  }
	  98% {
		left: 100%;
	  }
	  99% {
		left: 0;
	  }
	}
	
	@keyframes tostart {
	  75% {
		left: 0;
	  }
	  95% {
		left: -300%;
	  }
	  98% {
		left: -300%;
	  }
	  99% {
		left: 0;
	  }
	}
	
	@keyframes snap {
	  96% {
		scroll-snap-align: center;
	  }
	  97% {
		scroll-snap-align: none;
	  }
	  99% {
		scroll-snap-align: none;
	  }
	  100% {
		scroll-snap-align: center;
	  }
	}
	
	body {
	  max-width: 37.5rem;
	  margin: 0 auto;
	  padding: 0 1.25rem;
	  font-family: 'Lato', sans-serif;
	}
	
	* {
	  box-sizing: border-box;
	  scrollbar-color: transparent transparent; /* thumb and track color */
	  scrollbar-width: 0px;
	}
	
	*::-webkit-scrollbar {
	  width: 0;
	  display: none;
	}
	
	*::-webkit-scrollbar-track {
	  background: transparent;
	}

	*::-webkit-scrollbar-thumb {
	  background: transparent;
	  border: none;
	}
	
	* {
	  -ms-overflow-style: none;
	}
	
	ol, li {
	  list-style: none;
	  margin: 0;
	  padding: 0;
	}

	.scroll-snap-none{
		scroll-snap-type: x none;
	}

	.scroll-snap-man{
		scroll-snap-type: x mandatory;
	}
	
	.carousel {
	  position: relative;
	  padding-top: 75%;
	  filter: drop-shadow(0 0 10px #0003);
	  perspective: 100px;
	}
	
	.carousel__viewport {
	  position: absolute;
	  top: 0;
	  right: 0;
	  bottom: 0;
	  left: 0;
	  display: flex;
	  overflow-x: scroll;
	  overflow-y: hidden;
	  counter-reset: item;
	  scroll-behavior: smooth;
	  height: 4em;
	}
	
	.carousel__slide {
	  position: relative;
	  flex: 0 0 100%;
	  width: 100%;
	  background-color: transparent;
	  counter-increment: item;
	}
		
	.carousel__slide:before {
	  position: absolute;
	  top: 50%;
	  left: 50%;
	  transform: translate3d(-50%,-40%,70px);
	  color: #fff;
	  font-size: 2em;
	}
	
	.carousel__snapper {
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  scroll-snap-align: center;
	}
	
	@media (hover: hover) {
	  .carousel__snapper {
		animation-name: none;
		animation-timing-function: ease;
		animation-duration: 4s;
		animation-iteration-count: infinite;
	  }
	
	  .carousel__slide:last-child .carousel__snapper {
		animation-name: none;
	  }
	}
	
	@media (prefers-reduced-motion: reduce) {
	  .carousel__snapper {
		animation-name: none;
	  }
	}
	
	.carousel:hover .carousel__snapper,
	.carousel:focus-within .carousel__snapper {
	  animation-name: none;
	}
	
	.carousel__navigation {
	  position: absolute;
	  right: 0;
	  bottom: 0;
	  left: 0;
	  text-align: center;
	}
	
	.carousel__navigation-list,
	.carousel__navigation-item {
	  display: inline-block;
	}
	
	.carousel__navigation-button {
	  display: inline-block;
	  width: 1.5rem;
	  height: 1.5rem;
	  background-color: #333;
	  background-clip: content-box;
	  border: 0.25rem solid transparent;
	  border-radius: 50%;
	  font-size: 0;
	  transition: transform 0.1s;
	}
	
	.carousel__prev,
	.carousel__next {
	  position: absolute;
	  top: 0;
	  margin-top: 37.5%;
	  width: 4rem;
	  height: 4rem;
	  transform: translateY(-50%);
	  border-radius: 50%;
	  font-size: 0;
	  outline: 0;
	}
	
	.carousel::before,
	.carousel__prev {
	  left: -1rem;
	}
	
	.carousel::after,
	.carousel__next {
	  right: -1rem;
	}
	
	.carousel::before,
	.carousel::after {
	  z-index: 1;
	  background-color: #333;
	  background-size: 1.5rem 1.5rem;
	  background-repeat: no-repeat;
	  background-position: center center;
	  color: #fff;
	  font-size: 2.5rem;
	  line-height: 4rem;
	  text-align: center;
	  pointer-events: none;
	}

	.validator{
		color: gray;
		display: none;
	}

	.swipe-container{
		position: relative;
		margin: 0 auto;
		width: 100%;
	}

	.swipe-container{
		-webkit-transition: width 1s ease-in-out;
		-moz-transition: width 1s ease-in-out;
		-o-transition: width 1s ease-in-out;
		transition: width 1s ease-in-out;
	}

	.swipe-content{
		left: 0;
		right: 0;
		top: 0;
		bottom: 0;
		margin: auto;
		opacity: 50%; 
	}

	.swipe-icon{
		width: 3.5em; 
		height: 3.5em; 
		line-height:20px;
		position: absolute;
		padding: 5px 10px;
		border-radius: 50%;
		background: white;
		color: lightgray;
		display: flex;
		justify-content: center;
		align-items: center;
		font-size:1em;
		inset: 0;
  		margin: auto 0;
		margin-left: .25em;
	}

	.fade-in {
		animation: fadeIn 2s;
	}

	@keyframes fadeIn {
		0% { opacity: 0; }
		50% {opacity: 0;}
		100% { opacity: .5; }
	}


	.loader {
		position: absolute;
		border: 20px solid lightgray;
		border-top: 20px solid blue;
		border-radius: 50%;
		width: 60px;
		height: 60px;
		animation: load 2s linear infinite;
		z-index: -1;
		margin-left: .1em;
	}

	@keyframes load {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

</style>

	
<div class="container form-width">
	<form name="joinParty" action="" method="post">
		{% csrf_token %}
		{% if not party_name %}
		<h5>{{ form.party_code.label }}</h5>
		{{ form.party_code }}
		{% else %}
		<div class="d-none">{{ form.party_code }}</div>
		<h6>Join {{host}}'s Sesh</h6>
		<div class="text-center">
			<strong>{{ party_name | safe }}</strong>
		</div>
		{% endif %}
		<div id="code_text" class="ps-3 validator">
			<em>empty...need not empty</em>
		</div>
		<div id="code_validator" class="ps-3 validator">
			<em>we couldn't find a party with that code</em>
		</div>

		<div class="pt-2">
			<h5>{{ form.user_name.label }}</h5>
			{{ form.user_name }}
		</div>
		<div id="name_validator" class="ps-3 validator">
			<em>need some text here...could be anything</em>
		</div>
		<div id="button" class="pt-2 text-end">
			<input type="submit" class="btn btn-outline-light btn-lg block"
				style="border:3px solid black; border-radius:16px; color:black; display:block;" value="Submit">
		</div>
		<div id="swipe" class="swipe-container">
			<section id="carousel" class="carousel" style="margin-top:1em;">
				<ol id="main" class="carousel__viewport scroll-snap-man" style="border-radius: 500px;">
					<li id="carousel__slide1" tabindex="0" class="carousel__slide">
						<div class="carousel__snapper"></div>
					</li>
					<li id="carousel__slide2" tabindex="0" class="carousel__slide">
						<div class="carousel__snapper" style="text-align:left; color:lightgray ">
							<div id ="swipe_icon" class="swipe-icon" style="visibility: hidden;">
								<em id="chevron" class="fa-solid fa-chevron-right"></em>
							</div>
							<div id="loader" class = "loader swipe-icon" style="display:none;"></div>
						</div>
					</li>
				</ol>
			</section>
			<section id="carousel2" class="carousel" style="position: absolute; top:0; width:100%; z-index:-1;">
				<ol id="placeholder" class="carousel__viewport scroll-snap-man">
					<li tabindex="0" class="carousel__slide" style="background-color: lightgray; border-radius: 500px;">
						<div class="carousel__snapper" style="display:flex;">
							<div id="swipe_content" class="swipe-content fade-in">
								SLIDE TO CONTINUE
							</div>
						</div>
					</li>
				</ol>
			</section>
		</div>
	</form>
</div>
{% endblock %}
